version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: teslamate-cyberui-backend
    restart: unless-stopped
    environment:
      # Database configuration (connecting to external TeslaMate database)
      - TESLAMATE_DB_HOST=${TESLAMATE_DB_HOST}
      - TESLAMATE_DB_PORT=${TESLAMATE_DB_PORT:-5432}
      - TESLAMATE_DB_USER=${TESLAMATE_DB_USER}
      - TESLAMATE_DB_PASSWORD=${TESLAMATE_DB_PASSWORD}
      - TESLAMATE_DB_NAME=${TESLAMATE_DB_NAME}
      - TESLAMATE_DB_SSLMODE=${TESLAMATE_DB_SSLMODE:-disable}
      
      # Server configuration
      - CYBERUI_SERVER_HOST=${CYBERUI_SERVER_HOST:-0.0.0.0}
      - CYBERUI_SERVER_PORT=${CYBERUI_SERVER_PORT:-8080}
      - CYBERUI_SERVER_MODE=${CYBERUI_SERVER_MODE:-release}
      
      # Log configuration
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # Timezone from host
      - TZ=${TZ}
    networks:
      - teslamate-network
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    ports:
      - "8081:8080"
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: teslamate-cyberui
    restart: unless-stopped
    ports:
      - "8080:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - teslamate-network
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

networks:
  teslamate-network:
    driver: bridge
